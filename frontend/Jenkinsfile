pipeline {
    agent any

    environment {
        ANSIBLE_BIN = "/opt/homebrew/bin/ansible-playbook"
        PLAYBOOK    = "Ansible/playbook.yml"
        INVENTORY   = "Ansible/inventory.ini"
    }

    stages {
        stage('Verify Workspace') {
            steps {
                echo "Listing all files in workspace"
                sh 'ls -la'
            }
        }

        stage('Backend Build') {
            steps {
                dir('backend') {
                    sh '''
                    echo "Building backend..."
                    node -v
                    npm -v
                    npm install
                    npm audit fix || true
                    '''
                }
            }
        }

        stage('Deploy with Ansible on Mac') {
            steps {
                echo "Running Ansible playbook locally on macOS"
                sh '''
                $ANSIBLE_BIN -i $INVENTORY $PLAYBOOK --connection=local
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Checking Docker containers"
                sh 'docker compose ps || true'
            }
        }
    }

    post {
        success {
            echo "Deployment completed successfully ✅"
        }
        failure {
            echo "Deployment failed ❌"
            sh 'docker compose logs || true'
        }
    }
}
