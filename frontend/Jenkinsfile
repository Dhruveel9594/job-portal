pipeline {
    agent any

    environment {
        PATH = "/opt/homebrew/bin:/usr/local/bin:$PATH"
    }

    stages {
        stage('Verify Files') {
            steps {
                echo "Listing project files..."
                sh 'ls -la'
            }
        }

        stage('Ensure Homebrew & Docker') {
            steps {
                echo "Checking Homebrew, Docker & Docker Compose"
                sh '''
                    which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                    brew install docker || true
                    brew install docker-compose || true
                '''
            }
        }

        stage('Run Ansible Playbook') {
            steps {
                echo "Deploying Job Portal using Ansible"
                sh '''
                    /opt/homebrew/bin/ansible-playbook -i Ansible/inventory.ini Ansible/playbook.yml --connection=local
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                echo "Verifying Docker containers"
                sh 'docker compose -f /opt/job-portal/docker-compose.yml ps'
            }
        }
    }

    post {
        failure {
            echo "Deployment failed ❌"
            sh 'docker compose -f /opt/job-portal/docker-compose.yml logs || true'
        }
        success {
            echo "Deployment successful ✅"
        }
    }
}
